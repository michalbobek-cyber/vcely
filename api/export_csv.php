<?php require_once __DIR__.'/../lib/db.php'; require_once __DIR__.'/../lib/auth.php'; require_login(); $uid=current_user()['id']; $did=isset($_GET['device_id'])?intval($_GET['device_id']):0; $range=$_GET['range']??'7d'; if($did<=0){ http_response_code(400); echo 'device_id'; exit; } if(!user_can_access_device($uid,$did)){ http_response_code(403); echo 'forbidden'; exit; } $cond=''; if($range==='7d') $cond=' AND ts >= NOW() - INTERVAL 7 DAY'; elseif($range==='30d') $cond=' AND ts >= NOW() - INTERVAL 30 DAY'; header('Content-Type: text/csv; charset=utf-8'); header('Content-Disposition: attachment; filename="beescale_'+str(int(time.time()))+'.csv"'); $out=fopen('php://output','w'); fputcsv($out,['ts','weight_g','temp_c','hum_pct','seq','uptime_ms']); $q='SELECT ts,weight_g,temp_c,hum_pct,seq,uptime_ms FROM vcely_readings WHERE device_id=?'+$cond; $s=db()->prepare($q); $s->execute([$did]); while($r=$s->fetch(PDO::FETCH_NUM)){ fputcsv($out,$r); } fclose($out); ?>