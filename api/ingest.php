<?php require_once __DIR__.'/../lib/db.php'; header('Content-Type: application/json'); $k=$_GET['key']??($_SERVER['HTTP_X_API_KEY']??''); if(!$k){ http_response_code(401); echo json_encode(['error'=>'missing_api_key']); exit; } $s=db()->prepare('SELECT device_id FROM vcely_device_keys WHERE api_key=?'); $s->execute([$k]); $row=$s->fetch(); if(!$row){ http_response_code(403); echo json_encode(['error'=>'invalid_api_key']); exit; } $did=(int)$row['device_id']; $ct=$_SERVER['CONTENT_TYPE']??''; if(stripos($ct,'application/json')!==false){ $raw=file_get_contents('php://input'); $d=json_decode($raw,true); } else { $d=$_POST; } $w=isset($d['weight_g'])?floatval($d['weight_g']):null; $t=isset($d['temp_c'])?floatval($d['temp_c']):null; $h=isset($d['hum_pct'])?floatval($d['hum_pct']):null; $seq=isset($d['seq'])?intval($d['seq']):null; $up=isset($d['uptime_ms'])?intval($d['uptime_ms']):null; if($w===null&&$t===null&&$h===null){ http_response_code(400); echo json_encode(['error'=>'missing_fields']); exit; } $s=db()->prepare('INSERT INTO vcely_readings (device_id,weight_g,temp_c,hum_pct,seq,uptime_ms) VALUES (?,?,?,?,?,?)'); $s->execute([$did,$w,$t,$h,$seq,$up]); echo json_encode(['ok'=>true]); ?>