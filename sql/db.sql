CREATE TABLE IF NOT EXISTS vcely_users (id INT AUTO_INCREMENT PRIMARY KEY, email VARCHAR(190) NOT NULL UNIQUE, passhash VARCHAR(255) NOT NULL, created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
CREATE TABLE IF NOT EXISTS vcely_devices (id INT AUTO_INCREMENT PRIMARY KEY, user_id INT NOT NULL, name VARCHAR(190) NOT NULL, location VARCHAR(190), created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP, FOREIGN KEY (user_id) REFERENCES vcely_users(id) ON DELETE CASCADE) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
CREATE TABLE IF NOT EXISTS vcely_device_keys (id INT AUTO_INCREMENT PRIMARY KEY, device_id INT NOT NULL, api_key CHAR(64) NOT NULL UNIQUE, created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP, FOREIGN KEY (device_id) REFERENCES vcely_devices(id) ON DELETE CASCADE) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
CREATE TABLE IF NOT EXISTS vcely_device_settings (device_id INT PRIMARY KEY, enable_alerts TINYINT(1) DEFAULT 1, min_drop_g_24h DOUBLE DEFAULT 500, min_rise_g_24h DOUBLE DEFAULT 500, FOREIGN KEY (device_id) REFERENCES vcely_devices(id) ON DELETE CASCADE) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
CREATE TABLE IF NOT EXISTS vcely_readings (id BIGINT AUTO_INCREMENT PRIMARY KEY, device_id INT NOT NULL, ts TIMESTAMP DEFAULT CURRENT_TIMESTAMP, weight_g DOUBLE, temp_c DOUBLE, hum_pct DOUBLE, seq INT NULL, uptime_ms BIGINT NULL, INDEX idx_dev_ts (device_id, ts), FOREIGN KEY (device_id) REFERENCES vcely_devices(id) ON DELETE CASCADE) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
CREATE TABLE IF NOT EXISTS vcely_device_shares (device_id INT NOT NULL, user_id INT NOT NULL, role ENUM('viewer','editor') NOT NULL DEFAULT 'viewer', created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP, PRIMARY KEY (device_id,user_id), FOREIGN KEY (device_id) REFERENCES vcely_devices(id) ON DELETE CASCADE, FOREIGN KEY (user_id) REFERENCES vcely_users(id) ON DELETE CASCADE) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
CREATE TABLE IF NOT EXISTS vcely_alerts (id BIGINT AUTO_INCREMENT PRIMARY KEY, device_id INT NOT NULL, created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP, type VARCHAR(50) NOT NULL, message VARCHAR(255) NOT NULL, delta_g DOUBLE, FOREIGN KEY (device_id) REFERENCES vcely_devices(id) ON DELETE CASCADE) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
CREATE TABLE IF NOT EXISTS vcely_password_resets (id INT AUTO_INCREMENT PRIMARY KEY, user_id INT NOT NULL, email VARCHAR(190) NOT NULL, token_hash VARCHAR(255) NOT NULL, expires_at DATETIME NOT NULL, created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP, INDEX idx_email (email), FOREIGN KEY (user_id) REFERENCES vcely_users(id) ON DELETE CASCADE) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
CREATE TABLE IF NOT EXISTS vcely_alert_subscriptions (device_id INT NOT NULL, user_id INT NOT NULL, created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP, PRIMARY KEY (device_id,user_id), FOREIGN KEY (device_id) REFERENCES vcely_devices(id) ON DELETE CASCADE, FOREIGN KEY (user_id) REFERENCES vcely_users(id) ON DELETE CASCADE) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;