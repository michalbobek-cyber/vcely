<?php require_once __DIR__.'/../config.php'; require_once __DIR__.'/../lib/db.php'; $s=db()->query('SELECT d.id,d.name,s.enable_alerts,s.min_drop_g_24h,s.min_rise_g_24h FROM vcely_devices d LEFT JOIN vcely_device_settings s ON s.device_id=d.id'); $devs=$s->fetchAll(); foreach($devs as $d){ if(empty($d['enable_alerts'])) continue; $id=(int)$d['id']; $st=db()->prepare('SELECT weight_g,ts FROM vcely_readings WHERE device_id=? ORDER BY id DESC LIMIT 1'); $st->execute([$id]); $last=$st->fetch(); if(!$last) continue; $st=db()->prepare('SELECT weight_g,ts FROM vcely_readings WHERE device_id=? AND ts <= NOW() - INTERVAL 24 HOUR ORDER BY id DESC LIMIT 1'); $st->execute([$id]); $r24=$st->fetch(); if(!$r24) continue; $delta=$last['weight_g']-$r24['weight_g']; if($d['min_drop_g_24h']!==null && $delta<=-abs($d['min_drop_g_24h'])){ $msg='Rychlý úbytek za 24h: '.number_format($delta,1).' g'; $ins=db()->prepare('INSERT INTO vcely_alerts (device_id,type,message,delta_g) VALUES (?,?,?,?)'); $ins->execute([$id,'drop_24h',$msg,$delta]); } elseif($d['min_rise_g_24h']!==null && $delta>=abs($d['min_rise_g_24h'])){ $msg='Rychlý nárůst za 24h: '.number_format($delta,1).' g'; $ins=db()->prepare('INSERT INTO vcely_alerts (device_id,type,message,delta_g) VALUES (?,?,?,?)'); $ins->execute([$id,'rise_24h',$msg,$delta]); } } echo "OK\n"; ?>