<?php require_once __DIR__.'/config.php'; require_once __DIR__.'/lib/auth.php'; $path=parse_url($_SERVER['REQUEST_URI'],PHP_URL_PATH); $path=substr($path,strlen(BASE_URL)); if($path===false)$path='/'; $path=rtrim($path,'/'); if($path==='')$path='/'; function headx($t){echo '<!doctype html><html lang="cs"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>'.h($t).' – '.h(APP_NAME).'</title><link rel="stylesheet" href="https://unpkg.com/missing.css@1.1.2"></head><body><header><nav><a href="'.BASE_URL.'/">BeeScale</a> | <a href="'.BASE_URL.'/login">Přihlásit</a> | <a href="'.BASE_URL.'/register">Registrovat</a> | <a href="'.BASE_URL.'/forgot">Zapomenuté heslo</a></nav></header><main class="container">';} function foot(){echo '</main><footer><p>© '.date('Y').' BeeScale</p></footer></body></html>';}
switch($path){case '/': headx('Domů'); echo '<h1>BeeScale</h1>'; foot(); break; case '/register': if($_SERVER['REQUEST_METHOD']==='POST'){ $email=trim($_POST['email']??''); $pass=$_POST['password']??''; if(filter_var($email,FILTER_VALIDATE_EMAIL)&&strlen($pass)>=6){ try{ register_user($email,$pass); login($email,$pass); header('Location: '.BASE_URL.'/'); } catch(Throwable $e){ $err='Email už existuje.'; } } else { $err='Zadejte platný email a heslo min. 6 znaků.'; } } headx('Registrace'); if(!empty($err)) echo '<p class="danger">'.h($err).'</p>'; echo '<form method="post"><label>Email <input name="email" type="email" required></label><label>Heslo <input name="password" type="password" required></label><button>Registrovat</button></form>'; foot(); break; case '/login': if($_SERVER['REQUEST_METHOD']==='POST'){ $email=trim($_POST['email']??''); $pass=$_POST['password']??''; if(login($email,$pass)) { header('Location: '.BASE_URL.'/'); } else { $err='Neplatné přihlašovací údaje.'; } } headx('Přihlášení'); if(!empty($err)) echo '<p class="danger">'.h($err).'</p>'; echo '<form method="post"><label>Email <input name="email" type="email" required></label><label>Heslo <input name="password" type="password" required></label><button>Přihlásit</button></form>'; foot(); break; case '/forgot': if($_SERVER['REQUEST_METHOD']==='POST'){ $email=trim($_POST['email']??''); if(filter_var($email,FILTER_VALIDATE_EMAIL)){ create_reset_token($email); $msg='Pokud e-mail existuje, poslali jsme odkaz pro obnovu hesla.'; } else { $msg='Zadej platný e-mail.'; } } headx('Zapomenuté heslo'); if(!empty($msg)) echo '<p class="notice">'.h($msg).'</p>'; echo '<form method="post"><label>Email <input name="email" type="email" required></label><button>Odeslat odkaz</button></form>'; foot(); break; case '/reset': $email=$_GET['email']??($_POST['email']??''); $token=$_GET['token']??($_POST['token']??''); if($_SERVER['REQUEST_METHOD']==='POST'){ $p=$_POST['password']??''; $p2=$_POST['password2']??''; if($p===$p2 && strlen($p)>=6){ $res=reset_password_with_token($email,$token,$p); if($res===true){ $ok='Heslo změněno.'; } else { $err=$res; } } else { $err='Hesla se neshodují nebo jsou krátká.'; } } headx('Obnovení hesla'); if(!empty($ok)) echo '<p class="success">'.h($ok).'</p>'; if(!empty($err)) echo '<p class="danger">'.h($err).'</p>'; echo '<form method="post"><input type="hidden" name="email" value="'.h($email).'"><input type="hidden" name="token" value="'.h($token).'"><label>Nové heslo <input type="password" name="password" required></label><label>Potvrzení hesla <input type="password" name="password2" required></label><button>Změnit heslo</button></form>'; foot(); break; default: http_response_code(404); echo 'Not found'; } ?>